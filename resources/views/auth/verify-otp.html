<?php
$title = 'Verify Email - ZenBook';
ob_start();
?>
<div style="display: flex; justify-content: center; align-items: center; min-height: 85vh;">
    <div class="card" style="max-width: 450px; width: 100%;">
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="font-size: 48px; margin-bottom: 10px;">✉️</div>
            <h2 style="font-family: 'Playfair Display', serif; color: var(--text-dark); margin-bottom: 8px;">Verify Your Email</h2>
            <p style="color: var(--text-light); font-size: 14px;">Enter the 6-digit code sent to your email</p>
        </div>

        <?php if (session('success')): ?>
            <div class="alert alert-success" style="margin-bottom: 20px;">
                <?php echo htmlspecialchars(session('success')); ?>
            </div>
            <?php if (strpos(session('success'), 'verified successfully') !== false): ?>
                <script>
                    // Clear localStorage on successful verification
                    localStorage.removeItem('pending_verification_email');
                </script>
            <?php endif; ?>
        <?php endif; ?>

        <form method="POST" action="<?php echo route('otp.verify'); ?>">
            <input type="hidden" name="_token" value="<?php echo csrf_token(); ?>">
            
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" value="<?php echo htmlspecialchars(old('email', isset($email) ? $email : (session('email', '')))); ?>" required readonly style="background: var(--bg-light); cursor: not-allowed;">
            </div>

            <div class="form-group">
                <label for="otp">Enter OTP Code</label>
                <input type="text" id="otp" name="otp" value="<?php echo htmlspecialchars(old('otp', '')); ?>" required autofocus maxlength="6" pattern="[0-9]{6}" placeholder="000000" style="text-align: center; font-size: 32px; letter-spacing: 12px; font-weight: 600; padding: 20px;">
                <small style="color: var(--text-light); display: block; margin-top: 8px; font-size: 13px;">Enter the 6-digit code sent to your email</small>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 15px;">Verify OTP</button>
        </form>

        <form method="POST" action="<?php echo route('otp.resend'); ?>">
            <input type="hidden" name="_token" value="<?php echo csrf_token(); ?>">
            <input type="hidden" name="email" value="<?php echo htmlspecialchars(old('email', isset($email) ? $email : (session('email', '')))); ?>">
            <button type="submit" class="btn" style="width: 100%; background: white; color: var(--text-dark); border: 2px solid var(--border);">
                Resend OTP
            </button>
        </form>

        <div style="text-align: center; margin-top: 30px; padding-top: 30px; border-top: 1px solid var(--border);">
            <a href="<?php echo route('login'); ?>" style="color: var(--primary-dark); font-weight: 500; text-decoration: none; font-size: 14px;">← Back to Login</a>
        </div>
    </div>
</div>

<script>
    // Store email in localStorage for persistence
    document.addEventListener('DOMContentLoaded', function() {
        const emailInput = document.getElementById('email');
        const email = emailInput.value;
        
        if (email) {
            // Store email in localStorage so it persists even if tab is closed
            localStorage.setItem('pending_verification_email', email);
        } else {
            // Try to get email from localStorage if not in form
            const storedEmail = localStorage.getItem('pending_verification_email');
            if (storedEmail) {
                emailInput.value = storedEmail;
                // Update hidden email field in resend form
                const resendForm = document.querySelector('form[action*="resend"]');
                if (resendForm) {
                    const hiddenEmail = resendForm.querySelector('input[name="email"]');
                    if (hiddenEmail) {
                        hiddenEmail.value = storedEmail;
                    }
                }
            }
        }
        
        // Clear stored email after successful verification
        const verifyForm = document.querySelector('form[action*="verify"]');
        if (verifyForm) {
            verifyForm.addEventListener('submit', function() {
                // Don't clear immediately - wait for success
                // The success redirect will handle clearing
            });
        }
    });
    
    // Auto-focus and format OTP input
    document.getElementById('otp').addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
        if (this.value.length === 6) {
            this.form.submit();
        }
    });
</script>
<?php
$content = ob_get_clean();
$scripts = '<script>
    // Store email in localStorage for persistence
    document.addEventListener("DOMContentLoaded", function() {
        const emailInput = document.getElementById("email");
        const email = emailInput.value;
        
        if (email) {
            localStorage.setItem("pending_verification_email", email);
        } else {
            const storedEmail = localStorage.getItem("pending_verification_email");
            if (storedEmail) {
                emailInput.value = storedEmail;
                const resendForm = document.querySelector("form[action*=\'resend\']");
                if (resendForm) {
                    const hiddenEmail = resendForm.querySelector("input[name=\'email\']");
                    if (hiddenEmail) {
                        hiddenEmail.value = storedEmail;
                    }
                }
            }
        }
    });
    
    document.getElementById("otp").addEventListener("input", function(e) {
        this.value = this.value.replace(/[^0-9]/g, "");
        if (this.value.length === 6) {
            this.form.submit();
        }
    });
</script>';
include resource_path('views/layouts/app.html');
?>
